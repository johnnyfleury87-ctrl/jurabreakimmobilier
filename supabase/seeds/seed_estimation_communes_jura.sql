-- =====================================================================
-- SEED COMMUNES DU JURA
-- Fichier : supabase/seeds/seed_estimation_communes_jura.sql
-- =====================================================================
-- Source : docs/data/communes-jura.csv
-- Exécution : psql <connection_string> -f supabase/seeds/seed_estimation_communes_jura.sql
-- =====================================================================

BEGIN;

-- Créer ou récupérer les zones
INSERT INTO estimation_zones (id, nom, description, prix_m2_reference, actif)
VALUES
  ('00000000-0000-0000-0001-000000000001', 'Centre', 'Lons-le-Saunier et environs', 2000, true),
  ('00000000-0000-0000-0001-000000000002', 'Nord', 'Dole et environs', 1900, true),
  ('00000000-0000-0000-0001-000000000003', 'Haut-Jura', 'Saint-Claude, Morez, Les Rousses', 1800, true),
  ('00000000-0000-0000-0001-000000000004', 'Vignoble', 'Arbois, Poligny, Château-Chalon', 2000, true),
  ('00000000-0000-0000-0001-000000000005', 'Petite Montagne', 'Champagnole, Orgelet, Moirans', 1750, true)
ON CONFLICT (id) DO UPDATE
SET 
  nom = EXCLUDED.nom,
  description = EXCLUDED.description,
  prix_m2_reference = EXCLUDED.prix_m2_reference,
  actif = EXCLUDED.actif;

-- Supprimer les communes existantes pour seed propre (optionnel)
-- TRUNCATE estimation_communes CASCADE;

-- Insérer toutes les communes du Jura
INSERT INTO estimation_communes (nom, code_postal, zone_id, prix_m2_reference, actif)
VALUES
  -- Centre (Lons-le-Saunier)
  ('Lons-le-Saunier', '39000', '00000000-0000-0000-0001-000000000001', 2200, true),
  ('Conliège', '39570', '00000000-0000-0000-0001-000000000001', 1950, true),
  ('Crançot', '39570', '00000000-0000-0000-0001-000000000001', 1900, true),
  ('Montmorot', '39570', '00000000-0000-0000-0001-000000000001', 2050, true),
  ('Perrigny', '39570', '00000000-0000-0000-0001-000000000001', 2100, true),
  ('Courlaoux', '39570', '00000000-0000-0000-0001-000000000001', 1950, true),
  ('Gevingey', '39570', '00000000-0000-0000-0001-000000000001', 1900, true),
  ('Macornay', '39570', '00000000-0000-0000-0001-000000000001', 2000, true),
  ('Messia-sur-Sorne', '39570', '00000000-0000-0000-0001-000000000001', 1900, true),
  ('Montaigu', '39570', '00000000-0000-0000-0001-000000000001', 1950, true),
  ('Pannessières', '39570', '00000000-0000-0000-0001-000000000001', 1900, true),
  ('Trenal', '39570', '00000000-0000-0000-0001-000000000001', 1850, true),
  ('Bletterans', '39140', '00000000-0000-0000-0001-000000000001', 1700, true),
  ('Beaufort-Orbagna', '39190', '00000000-0000-0000-0001-000000000001', 1700, true),
  ('Sellières', '39190', '00000000-0000-0000-0001-000000000001', 1700, true),
  ('Domblans', '39210', '00000000-0000-0000-0001-000000000001', 1700, true),
  
  -- Nord (Dole)
  ('Dole', '39100', '00000000-0000-0000-0001-000000000002', 2100, true),
  ('Tavaux', '39500', '00000000-0000-0000-0001-000000000002', 1850, true),
  ('Rochefort-sur-Nenon', '39700', '00000000-0000-0000-0001-000000000002', 1900, true),
  ('Choisey', '39100', '00000000-0000-0000-0001-000000000002', 1900, true),
  ('Damparis', '39100', '00000000-0000-0000-0001-000000000002', 1950, true),
  ('Foucherans', '39100', '00000000-0000-0000-0001-000000000002', 1850, true),
  ('Parcey', '39100', '00000000-0000-0000-0001-000000000002', 1800, true),
  ('Sampans', '39100', '00000000-0000-0000-0001-000000000002', 1850, true),
  ('Villette-lès-Dole', '39100', '00000000-0000-0000-0001-000000000002', 1900, true),
  ('Chaussin', '39120', '00000000-0000-0000-0001-000000000002', 1750, true),
  ('Saint-Amour', '39160', '00000000-0000-0000-0001-000000000002', 1750, true),
  ('Evans', '39500', '00000000-0000-0000-0001-000000000002', 1750, true),
  ('Asnans-Beauvoisin', '39500', '00000000-0000-0000-0001-000000000002', 1700, true),
  ('Champvans', '39500', '00000000-0000-0000-0001-000000000002', 1700, true),
  ('Longwy-sur-le-Doubs', '39500', '00000000-0000-0000-0001-000000000002', 1700, true),
  
  -- Haut-Jura (Saint-Claude, Morez)
  ('Saint-Claude', '39200', '00000000-0000-0000-0001-000000000003', 1800, true),
  ('Morez', '39400', '00000000-0000-0000-0001-000000000003', 1700, true),
  ('Les Rousses', '39220', '00000000-0000-0000-0001-000000000003', 2500, true),
  ('Saint-Laurent-en-Grandvaux', '39150', '00000000-0000-0000-0001-000000000003', 1800, true),
  ('Septmoncel', '39310', '00000000-0000-0000-0001-000000000003', 1750, true),
  ('Lamoura', '39310', '00000000-0000-0000-0001-000000000003', 2200, true),
  ('Lajoux', '39310', '00000000-0000-0000-0001-000000000003', 1750, true),
  ('Les Molunes', '39310', '00000000-0000-0000-0001-000000000003', 1900, true),
  ('Septmoncel-les-Molunes', '39310', '00000000-0000-0000-0001-000000000003', 1950, true),
  ('Prémanon', '39400', '00000000-0000-0000-0001-000000000003', 2000, true),
  ('Longchaumois', '39400', '00000000-0000-0000-0001-000000000003', 1850, true),
  ('Morbier', '39400', '00000000-0000-0000-0001-000000000003', 1800, true),
  ('Bellefontaine', '39400', '00000000-0000-0000-0001-000000000003', 1750, true),
  ('Hauts de Bienne', '39400', '00000000-0000-0000-0001-000000000003', 1700, true),
  ('Foncine-le-Haut', '39460', '00000000-0000-0000-0001-000000000003', 1700, true),
  ('Foncine-le-Bas', '39460', '00000000-0000-0000-0001-000000000003', 1650, true),
  ('Lavans-lès-Saint-Claude', '39170', '00000000-0000-0000-0001-000000000003', 1700, true),
  ('Vaux-lès-Saint-Claude', '39580', '00000000-0000-0000-0001-000000000003', 1700, true),
  ('Chassal-Molinges', '39360', '00000000-0000-0000-0001-000000000003', 1650, true),
  ('Mignovillard', '39250', '00000000-0000-0000-0001-000000000003', 1700, true),
  ('Nozeroy', '39250', '00000000-0000-0000-0001-000000000003', 1650, true),
  
  -- Vignoble (Arbois, Poligny)
  ('Arbois', '39600', '00000000-0000-0000-0001-000000000004', 2150, true),
  ('Poligny', '39800', '00000000-0000-0000-0001-000000000004', 2000, true),
  ('L''Étoile', '39570', '00000000-0000-0000-0001-000000000004', 2000, true),
  ('Château-Chalon', '39210', '00000000-0000-0000-0001-000000000004', 2100, true),
  ('Les Arsures', '39600', '00000000-0000-0000-0001-000000000004', 2000, true),
  ('Pupillin', '39430', '00000000-0000-0000-0001-000000000004', 1850, true),
  ('Montigny-lès-Arsures', '39430', '00000000-0000-0000-0001-000000000004', 1800, true),
  ('Mesnay', '39600', '00000000-0000-0000-0001-000000000004', 1950, true),
  ('Villette-lès-Arbois', '39600', '00000000-0000-0000-0001-000000000004', 1900, true),
  ('Voiteur', '39210', '00000000-0000-0000-0001-000000000004', 1750, true),
  ('Menétru-le-Vignoble', '39210', '00000000-0000-0000-0001-000000000004', 1800, true),
  ('Le Vernois', '39210', '00000000-0000-0000-0001-000000000004', 1750, true),
  ('Salins-les-Bains', '39110', '00000000-0000-0000-0001-000000000004', 1900, true),
  ('Clairvaux-les-Lacs', '39130', '00000000-0000-0000-0001-000000000004', 1850, true),
  ('Doucier', '39130', '00000000-0000-0000-0001-000000000004', 1750, true),
  ('Arlay', '39140', '00000000-0000-0000-0001-000000000004', 1800, true),
  ('Port-Lesney', '39330', '00000000-0000-0000-0001-000000000004', 1800, true),
  ('Aiglepierre', '39110', '00000000-0000-0000-0001-000000000004', 1850, true),
  ('Les Planches-près-Arbois', '39430', '00000000-0000-0000-0001-000000000004', 1750, true),
  ('Mouchard', '39290', '00000000-0000-0000-0001-000000000004', 1700, true),
  
  -- Petite Montagne (Champagnole, Orgelet)
  ('Champagnole', '39300', '00000000-0000-0000-0001-000000000005', 1900, true),
  ('Orgelet', '39270', '00000000-0000-0000-0001-000000000005', 1650, true),
  ('Moirans-en-Montagne', '39260', '00000000-0000-0000-0001-000000000005', 1750, true),
  ('Arinthod', '39240', '00000000-0000-0000-0001-000000000005', 1650, true),
  ('Le Frasnois', '39300', '00000000-0000-0000-0001-000000000005', 1750, true),
  ('Syam', '39300', '39000000-0000-0000-0001-000000000005', 1700, true),
  ('Bourg-de-Sirod', '39300', '00000000-0000-0000-0001-000000000005', 1700, true),
  ('Les Planches-en-Montagne', '39300', '00000000-0000-0000-0001-000000000005', 1650, true),
  ('Pont-de-Poitte', '39270', '00000000-0000-0000-0001-000000000005', 1650, true),
  ('La Tour-du-Meix', '39260', '00000000-0000-0000-0001-000000000005', 1650, true),
  ('Martigna', '39260', '00000000-0000-0000-0001-000000000005', 1650, true),
  ('Maisod', '39270', '00000000-0000-0000-0001-000000000005', 1600, true),
  ('Val-Sonnette', '39270', '00000000-0000-0000-0001-000000000005', 1650, true),
  ('Billecul', '39300', '00000000-0000-0000-0001-000000000005', 1650, true),
  ('Monnet-la-Ville', '39300', '00000000-0000-0000-0001-000000000005', 1650, true)
ON CONFLICT (nom, code_postal) DO UPDATE
SET 
  zone_id = EXCLUDED.zone_id,
  prix_m2_reference = EXCLUDED.prix_m2_reference,
  actif = EXCLUDED.actif;

COMMIT;

-- Vérification
SELECT 
  z.nom as zone,
  COUNT(c.id) as nb_communes,
  ROUND(AVG(c.prix_m2_reference)) as prix_m2_moyen
FROM estimation_zones z
LEFT JOIN estimation_communes c ON c.zone_id = z.id
GROUP BY z.nom
ORDER BY z.nom;

SELECT 
  code_postal,
  COUNT(*) as nb_communes
FROM estimation_communes
GROUP BY code_postal
HAVING COUNT(*) > 1
ORDER BY code_postal;
